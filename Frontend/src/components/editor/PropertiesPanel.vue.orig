<script setup lang="ts">
import { ref, computed } from 'vue'
import { useEditorStore } from '@/stores/editor'
import { textPresets } from '@/data/textPresets'
import { Sparkles, Palette, Sliders, Type, Grid3X3, Wand2, AlignLeft, AlignCenter, AlignRight, AlignJustify, Waves, Box } from 'lucide-vue-next'
import { displayFonts, commonFonts, loadGoogleFont, uploadCustomFont } from '@/utils/fontManager'
import PresetBrowser from './PresetBrowser.vue'

const store = useEditorStore()
const activeTab = ref('text')
const originalFont = ref('')

const activeObject = computed(() => {
  return store.canvasObjects.find(o => o.id === store.activeLayerId) || null
})

const gradientStyle = computed(() => {
  if (!activeObject.value?.gradient || !activeObject.value.gradient.stops.length) return ''
  const stops = activeObject.value.gradient.stops
    .map(s => `${s.color} ${s.offset * 100}%`)
    .join(', ')
  return `linear-gradient(${activeObject.value.gradient.rotation}deg, ${stops})`
})

const previewFont = (font: string) => {
  if (activeObject.value && activeObject.value.type === 'text') {
    if (!originalFont.value) {
      originalFont.value = activeObject.value.fontFamily || 'Inter'
    }
    loadGoogleFont(font)
    activeObject.value.fontFamily = font
  }
}

const restoreFont = () => {
  if (activeObject.value && activeObject.value.type === 'text' && originalFont.value) {
    activeObject.value.fontFamily = originalFont.value
    originalFont.value = ''
  }
}

const selectFont = (font: string) => {
  if (activeObject.value && activeObject.value.type === 'text') {
    loadGoogleFont(font)
    activeObject.value.fontFamily = font
    originalFont.value = '' 
    store.saveState()
  }
}

const handleFontUpload = async (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (!file) return
  
  try {
    const fontName = await uploadCustomFont(file)
    if (activeObject.value && activeObject.value.type === 'text') {
       activeObject.value.fontFamily = fontName
       store.saveState()
    }
  } catch (err) {
    console.error('Font upload failed:', err)
    alert('Failed to load font. Please ensure it is a valid TTF/OTF file.')
  }
}

const applyEffect = async (effectType: string) => {
  const result = await store.processImage('effect', { effectType, intensity: 1 })
  if (result && (result as any).type === 'effect_applied') {
    updateImageFromPixels((result as any).imageData)
  }
}

const updateImageFromPixels = (pixels: Uint8ClampedArray) => {
  const img = new Image()
  img.src = store.uploadedFile!
  img.onload = () => {
    const canvas = document.createElement('canvas')
    canvas.width = img.width
    canvas.height = img.height
    const ctx = canvas.getContext('2d')!
    const imgData = ctx.createImageData(canvas.width, canvas.height)
    imgData.data.set(pixels)
    ctx.putImageData(imgData, 0, 0)
    store.uploadedFile = canvas.toDataURL('image/png')
  }
}

const effects = [
  { id: 'thermal', name: 'Thermal', icon: 'üî•' },
  { id: 'glitch', name: 'Digital Glitch', icon: 'üëæ' },
  { id: 'vintage', name: 'Vintage 90s', icon: 'üì∑' },
]

const fillType = ref<'solid' | 'gradient' | 'pattern'>('solid')

const initFill = (type: 'solid' | 'gradient' | 'pattern') => {
  if (!activeObject.value) return
  
  if (type === 'solid') {
    activeObject.value.fillType = 'solid'
    if (!activeObject.value.fill) activeObject.value.fill = '#000000'
    activeObject.value.gradient = undefined
    activeObject.value.pattern = undefined
  } else if (type === 'gradient') {
    activeObject.value.fillType = 'gradient'
    if (!activeObject.value.gradient) {
      activeObject.value.gradient = {
        type: 'linear',
        stops: [
          { offset: 0, color: activeObject.value.fill || '#000000' },
          { offset: 1, color: '#ffffff' }
        ],
        rotation: 0
      }
    }
  } else if (type === 'pattern') {
    activeObject.value.fillType = 'pattern'
    // Pattern requires upload, handled by handlePatternUpload
  }
  fillType.value = type
  store.saveState()
}

const addGradientStop = (e: any) => {
  if (!activeObject.value?.gradient) return
  const rect = (e.target as HTMLElement).getBoundingClientRect()
  const offset = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width))
  
  // Find colors to blend
  const stops = activeObject.value.gradient.stops
  const prevStop = stops.reduce((prev, curr) => curr.offset <= offset && curr.offset > prev.offset ? curr : prev, { offset: 0, color: '#000000' })
  
  activeObject.value.gradient.stops.push({ offset, color: prevStop.color })
  activeObject.value.gradient.stops.sort((a, b) => a.offset - b.offset)
  store.saveState()
}

const removeGradientStop = (index: number) => {
  if (!activeObject.value?.gradient || activeObject.value.gradient.stops.length <= 2) return
  activeObject.value.gradient.stops.splice(index, 1)
  store.saveState()
}

const updateGradientStopColor = (index: number, color: string) => {
   if (activeObject.value?.gradient) {
     activeObject.value.gradient.stops[index].color = color
     store.saveState()
   }
}

const handlePatternUpload = (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (!file || !activeObject.value) return
  
  const reader = new FileReader()
  reader.onload = (e) => {
    if (e.target?.result && activeObject.value) {
      activeObject.value.fillType = 'pattern'
      activeObject.value.pattern = {
        source: e.target.result as string,
        repeat: 'repeat',
        scaleX: 1,
        scaleY: 1,
        rotation: 0
      }
      fillType.value = 'pattern'
      store.saveState()
    }
  }
  reader.readAsDataURL(file)
}

const uniqueId = () => Math.random().toString(36).substr(2, 9)

const addStroke = () => {
  if (!activeObject.value) return
  if (!activeObject.value.strokes) activeObject.value.strokes = []
  
  activeObject.value.strokes.push({
    id: uniqueId(),
    color: '#000000',
    width: 2,
    opacity: 1
  })
  store.saveState()
}

const removeStroke = (index: number) => {
  if (!activeObject.value?.strokes) return
  activeObject.value.strokes.splice(index, 1)
  store.saveState()
}

const addShadow = () => {
  if (!activeObject.value) return
  if (!activeObject.value.shadows) activeObject.value.shadows = []
  
  activeObject.value.shadows.push({
    id: uniqueId(),
    color: '#000000',
    blur: 10,
    offsetX: 5,
    offsetY: 5,
    opacity: 0.5
  })
  store.saveState()
}

const removeShadow = (index: number) => {
   if (!activeObject.value?.shadows) return
   activeObject.value.shadows.splice(index, 1)
   store.saveState()
}

// Preset Effects
const applyNeonGlow = () => {
  if (!activeObject.value) return
  activeObject.value.shadows = [
    { id: uniqueId(), color: activeObject.value.fill || '#ff00ff', blur: 10, offsetX: 0, offsetY: 0, opacity: 1 },
    { id: uniqueId(), color: activeObject.value.fill || '#ff00ff', blur: 40, offsetX: 0, offsetY: 0, opacity: 0.8 },
    { id: uniqueId(), color: activeObject.value.fill || '#ff00ff', blur: 90, offsetX: 0, offsetY: 0, opacity: 0.5 }
  ]
  activeObject.value.fill = '#ffffff' // White core for neon
  store.saveState()
}

const handleWarpChange = () => {
  if (activeObject.value && !activeObject.value.warp) {
    activeObject.value.warp = { style: 'none', amount: 0 }
  }
  store.saveState()
}

const handleThreeDChange = () => {
  if (activeObject.value && !activeObject.value.threeD) {
    activeObject.value.threeD = { 
      enabled: false, 
      depth: 20, 
      rotationX: 0, 
      rotationY: 0, 
      rotationZ: 0, 
      materialType: 'standard' 
    }
  }
  store.saveState()
}

const handleDirectionChange = (e: any) => {
  if (activeObject.value) {
    activeObject.value.direction = e.target.checked ? 'rtl' : 'ltr'
    store.saveState()
  }
}

const handleGradientStopInput = (index: number, e: any) => {
  updateGradientStopColor(index, e.target.value)
}
</script>

<template>
  <div class="panel">
    <div class="tabs">
      <div class="tab" :class="{ active: activeTab === 'presets' }" @click="activeTab = 'presets'"><Grid3X3 :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'text' }" @click="activeTab = 'text'"><Type :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'style' }" @click="activeTab = 'style'"><Wand2 :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'warp' }" @click="activeTab = 'warp'"><Waves :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === '3d' }" @click="activeTab = '3d'"><Box :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'colors' }" @click="activeTab = 'colors'"><Palette :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'effects' }" @click="activeTab = 'effects'"><Sparkles :size="16" /></div>
      <div class="tab" :class="{ active: activeTab === 'adjust' }" @click="activeTab = 'adjust'"><Sliders :size="16" /></div>
    </div>

    <div class="panel-content">
      <!-- PRESETS BROWSER -->
      <div v-if="activeTab === 'presets'" class="preset-section">
        <PresetBrowser />
      </div>

      <!-- TEXT STYLES -->
      <div v-if="activeTab === 'text'">
        <h3 class="panel-title">Typography</h3>
        <div v-if="activeObject && activeObject.type === 'text'" class="section">
          <!-- (Keep existing fonts list...) -->
            <div class="control">
            <div class="label-row"><label>Alignment</label></div>
            <div class="tabs-small">
              <button class="tab-small" :class="{ active: activeObject.align === 'left' }" @click="activeObject.align = 'left'"><AlignLeft :size="14"/></button>
              <button class="tab-small" :class="{ active: activeObject.align === 'center' }" @click="activeObject.align = 'center'"><AlignCenter :size="14"/></button>
              <button class="tab-small" :class="{ active: activeObject.align === 'right' }" @click="activeObject.align = 'right'"><AlignRight :size="14"/></button>
              <button class="tab-small" :class="{ active: activeObject.align === 'justify' }" @click="activeObject.align = 'justify'"><AlignJustify :size="14"/></button>
            </div>
          </div>
          
           <div class="control">
            <div class="label-row">
              <label>Direction (RTL)</label>
              <input type="checkbox" :checked="activeObject.direction === 'rtl'" @change="handleDirectionChange" />
            </div>
          </div>

           <div class="control">
            <label class="label-row">Font Family</label>
            <div class="font-actions">
               <label class="mini-btn">
                 Upload Font
                 <input type="file" hidden accept=".ttf,.otf" @change="handleFontUpload" />
               </label>
            </div>
            <div class="font-dropdown-container mt-2">
              <div class="font-list-custom">
                <div 
                  v-for="font in displayFonts" 
                  :key="font" 
                  class="font-option"
                  :class="{ active: activeObject.fontFamily === font }"
                  :style="{ fontFamily: font }"
                  @mouseenter="previewFont(font)"
                  @mouseleave="restoreFont()"
                  @click="selectFont(font)"
                >
                  {{ font }}
                </div>
                <div class="divider-text">Common Fonts</div>
                <div 
                  v-for="font in commonFonts" 
                  :key="font" 
                  class="font-option"
                  :class="{ active: activeObject.fontFamily === font }"
                  :style="{ fontFamily: font }"
                  @mouseenter="previewFont(font)"
                  @mouseleave="restoreFont()"
                  @click="selectFont(font)"
                >
                  {{ font }}
                </div>
              </div>
            </div>
          </div>

          <div class="control">
            <div class="label-row"><label>Font Size</label><span>{{ activeObject.fontSize }}px</span></div>
            <input type="range" v-model="activeObject.fontSize" min="10" max="250" />
          </div>
          <div class="control">
            <div class="label-row"><label>Letter Spacing</label><span>{{ activeObject.letterSpacing || 0 }}</span></div>
            <input type="range" v-model="activeObject.letterSpacing" min="-10" max="100" />
          </div>
           <div class="control">
            <div class="label-row"><label>Line Height</label><span>{{ activeObject.lineHeight || 1.2 }}</span></div>
            <input type="range" v-model="activeObject.lineHeight" min="0.5" max="3" step="0.1" />
          </div>
          <div class="control">
            <label class="label-row">Color</label>
            <input type="color" v-model="activeObject.fill" class="full-color-input" />
          </div>
        </div>
        <div v-else class="empty-note">
          Select text to edit.
        </div>
      </div>

      <!-- ADVANCED ENGINE STYLING -->
      <div v-if="activeTab === 'style'">
        <h3 class="panel-title">Styling Engine</h3>
        <div v-if="activeObject && activeObject.type === 'text'" class="section">
          <!-- Advanced Shadows (Multi-layer) -->
          <div class="style-group">
            <div class="label-row">
              Effects & Glows
              <div class="header-actions">
                <button class="mini-btn-icon" @click="applyNeonGlow" title="Neon Preset">‚ú®</button>
                <button class="mini-btn-icon" @click="addShadow" title="Add Shadow">Ôºã</button>
              </div>
            </div>
            
            <div v-for="(shadow, index) in activeObject.shadows" :key="shadow.id" class="layer-card">
              <div class="layer-header">
                <span>Shadow {{ index + 1 }}</span>
                <button class="remove-layer" @click="removeShadow(index)">√ó</button>
              </div>
              <div class="layer-body">
                <div class="control-row">
                   <input type="color" v-model="shadow.color" class="full-color-input" />
                </div>
                <div class="grid-controls mt-2">
                   <div class="small-control"><label>Blur</label><input type="number" v-model="shadow.blur" /></div>
                   <div class="small-control"><label>X</label><input type="number" v-model="shadow.offsetX" /></div>
                   <div class="small-control"><label>Y</label><input type="number" v-model="shadow.offsetY" /></div>
                   <div class="small-control"><label>Op</label><input type="number" v-model="shadow.opacity" step="0.1" max="1" /></div>
                </div>
              </div>
            </div>
            <div v-if="!activeObject.shadows?.length" class="empty-state-small">No effects added.</div>
          </div>

          <!-- Advanced Strokes (Multi-layer) -->
          <div class="style-group">
            <div class="label-row">
              Outlines (Strokes)
              <button class="mini-btn-icon" @click="addStroke" title="Add Stroke">Ôºã</button>
            </div>
            
            <div v-for="(stroke, index) in activeObject.strokes" :key="stroke.id" class="layer-card">
               <div class="layer-header">
                <span>Stroke {{ index + 1 }}</span>
                <button class="remove-layer" @click="removeStroke(index)">√ó</button>
              </div>
              <div class="layer-body">
                 <div class="control-row">
                   <label>Width: {{ stroke.width }}px</label>
                   <input type="range" v-model="stroke.width" min="0" max="100" />
                 </div>
                 <div class="control-row mt-2">
                   <input type="color" v-model="stroke.color" class="full-color-input" />
                 </div>
              </div>
            </div>
            <div v-if="!activeObject.strokes?.length" class="empty-state-small">No strokes added.</div>
          </div>
          
          <!-- Fill Engine -->
          <div class="style-group">
            <div class="label-row">Fill Engine</div>
            <div class="tabs-small mb-4">
               <button class="tab-small" :class="{ active: fillType === 'solid' }" @click="initFill('solid')">Solid</button>
               <button class="tab-small" :class="{ active: fillType === 'gradient' }" @click="initFill('gradient')">Gradient</button>
               <button class="tab-small" :class="{ active: fillType === 'pattern' }" @click="initFill('pattern')">Image</button>
            </div>

            <!-- Solid -->
            <div v-if="fillType === 'solid'" class="control-row">
              <input type="color" v-model="activeObject.fill" class="full-color-input" />
            </div>

            <!-- Gradient -->
            <div v-if="fillType === 'gradient' && activeObject.gradient" class="control-column">
               <div class="gradient-editor">
                 <div class="gradient-ramp" :style="{ background: gradientStyle }" @click="addGradientStop">
                    <div 
                      v-for="(stop, index) in activeObject.gradient.stops" 
                      :key="index"
                      class="gradient-thumb"
                      :style="{ left: (stop.offset * 100) + '%' }"
                      @click.stop
                    >
                      <input 
                        type="color" 
                        :value="stop.color"
                        @input="e => handleGradientStopInput(index, e)" 
                      />
                      <button class="remove-stop" @click.stop="removeGradientStop(index)" v-if="activeObject.gradient.stops.length > 2">√ó</button>
                    </div>
                 </div>
               </div>
               
               <div class="control-row mt-2">
                 <label>Angle</label>
                 <input type="range" v-model="activeObject.gradient.rotation" min="0" max="360" />
               </div>
               
               <div class="control-row mt-2">
                  <label>Type</label>
                  <select v-model="activeObject.gradient.type" class="mini-select">
                    <option value="linear">Linear</option>
                    <option value="radial">Radial</option>
                  </select>
               </div>
            </div>

            <!-- Pattern / Image -->
            <div v-if="fillType === 'pattern'" class="control-column">
              <label class="btn-outline">
                Choose Image...
                <input type="file" hidden accept="image/*" @change="handlePatternUpload" />
              </label>
              
              <div v-if="activeObject.pattern" class="mt-2">
                 <div class="control-row">
                   <label>Scale X</label>
                   <input type="range" v-model="activeObject.pattern.scaleX" min="0.1" max="5" step="0.1" />
                 </div>
                 <div class="control-row">
                   <label>Scale Y</label>
                   <input type="range" v-model="activeObject.pattern.scaleY" min="0.1" max="5" step="0.1" />
                 </div>
              </div>
            </div>
            
            <div class="divider-line my-2"></div>
            
            <div class="control-row">
              <label>Noise Texture</label>
              <input type="range" v-model="activeObject.noise" min="0" max="1" step="0.05" />
            </div>
          </div>

          <!-- Opacity -->
          <div class="style-group">
            <div class="label-row">Layer Opacity ({{ Math.round(activeObject.opacity * 100) }}%)</div>
            <input type="range" v-model="activeObject.opacity" min="0" max="1" step="0.01" />
          </div>
        </div>
        <div v-else class="empty-note">Select text to style.</div>
      </div>

      <!-- IMAGE ADJUSTMENTS (PRO) -->
      <div v-if="activeTab === 'adjust'">
        <h3 class="panel-title">Pro Adjustments</h3>
        
        <div class="section">
          <div class="label-row sub-header">Light & Color</div>
          
          <div class="control">
            <div class="label-row"><label>Exposure</label><span>{{ store.brightness }}</span></div>
            <input type="range" v-model="store.brightness" min="-100" max="100" />
          </div>
          <div class="control">
            <div class="label-row"><label>Contrast</label><span>{{ store.contrast }}</span></div>
            <input type="range" v-model="store.contrast" min="-100" max="100" />
          </div>
           <div class="control">
            <div class="label-row"><label>Saturation</label><span>0</span></div>
            <input type="range"  min="-100" max="100" title="Coming in v2" disabled style="opacity: 0.5"/>
          </div>
          <div class="control">
            <div class="label-row"><label>Vibrance</label><span>0</span></div>
            <input type="range" min="-100" max="100" title="Coming in v2" disabled style="opacity: 0.5"/>
          </div>
        </div>

        <div class="section">
          <div class="label-row sub-header">Detail</div>
           <div class="control">
            <div class="label-row"><label>Sharpness</label><span>0</span></div>
            <input type="range" min="0" max="100" disabled style="opacity: 0.5"/>
          </div>
           <div class="control">
            <div class="label-row"><label>Blur</label><span>0</span></div>
            <input type="range" min="0" max="100" disabled style="opacity: 0.5"/>
          </div>
        </div>

        <div v-if="activeObject" class="section transform-section">
          <h3 class="panel-title sub">Transform</h3>
          <div class="grid-controls">
            <div class="small-control"><label>X</label><input type="number" v-model="activeObject.x" /></div>
            <div class="small-control"><label>Y</label><input type="number" v-model="activeObject.y" /></div>
            <div class="small-control"><label>W</label><input type="number"  disabled title="Read Only"/></div>
             <div class="small-control"><label>H</label><input type="number" disabled title="Read Only"/></div>
            <div class="small-control"><label>ROT</label><input type="number" v-model="activeObject.rotation" /></div>
          </div>
        </div>
      </div>

      <!-- COLOR REPLACEMENT -->
      <div v-if="activeTab === 'colors'">
        <h3 class="panel-title">AI Color Replace</h3>
        <div v-if="store.selectedColors.length" class="section">
          <div class="color-list">
            <div v-for="color in store.selectedColors" :key="color.original" class="color-item">
              <div :style="{ backgroundColor: color.original }" class="color-swatch box-shadow-sm"></div>
              <input type="color" v-model="color.newColor" class="color-picker-mini" />
              <button class="remove-btn" @click="store.removeColorChange(color.original)">√ó</button>
            </div>
          </div>
          <button class="apply-btn primary" @click="store.processImage('apply')">Process Colors (AI)</button>
        </div>
        <p v-else class="empty-note">
          Select 'Eyedropper' tool and click image to auto-detect editable color regions.
        </p>
      </div>

      <!-- EFFECTS -->
      <div v-if="activeTab === 'effects'">
        <h3 class="panel-title">Smart Filters</h3>
        <div class="effects-grid">
          <div v-for="effect in effects" :key="effect.id" class="effect-card" @click="applyEffect(effect.id)">
            <div class="effect-icon">{{ effect.icon }}</div>
            <span class="effect-name">{{ effect.name }}</span>
          </div>
          <!-- New Pro Filters -->
           <div class="effect-card" title="Auto Levels (AI)">
            <div class="effect-icon">ü™Ñ</div>
            <span class="effect-name">Auto Enhance</span>
          </div>
           <div class="effect-card" title="Remove Background (AI)">
            <div class="effect-icon">‚úÇÔ∏è</div>
            <span class="effect-name">Remove BG</span>
          </div>
           <div class="effect-card" title="Noise">
            <div class="effect-icon">üå´Ô∏è</div>
            <span class="effect-name">Add Noise</span>
          </div>
           <div class="effect-card" title="Vignette">
            <div class="effect-icon">üåë</div>
            <span class="effect-name">Vignette</span>
          </div>
        </div>
      </div>

      <!-- WARP TAB (Temporarily hidden for debugging)
      <div v-if="activeTab === 'warp'">
        <h3 class="panel-title">Text Warp</h3>
        <div v-if="activeObject && activeObject.type === 'text'" class="section">
          <div class="style-group">
            <div class="label-row">Warp Style</div>
            <select v-model="activeObject.warp.style" class="mini-select mb-2" @change="handleWarpChange">
              <option value="none">None</option>
              <option value="arc">Arc (Smile)</option>
              <option value="arc-lower">Arc Lower (Frown)</option>
              <option value="arch">Arch</option>
              <option value="wave">Wave</option>
            </select>
            
            <div v-if="activeObject.warp && activeObject.warp.style !== 'none'" class="control mt-2">
              <div class="label-row"><label>Amount</label><span>{{ activeObject.warp.amount }}</span></div>
              <input type="range" v-model="activeObject.warp.amount" min="-100" max="100" @input="store.saveState()" />
            </div>
          </div>
        </div>
        <div v-else class="empty-note">Select text to warp.</div>
      </div>
      -->

      <!-- 3D TAB (Temporarily hidden for debugging)
      <div v-if="activeTab === '3d'">
        ... existing 3D content ...
      </div>
      -->
    </div>
  </div>
</template>

<style scoped>
.panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  color: var(--text-primary);
  background: transparent; /* Background handled by parent skeleton */
}

/* Tabs */
.tabs {
  display: flex;
  background-color: var(--bg-panel);
  height: 48px;
  border-bottom: 1px solid var(--border-color);
  padding: 0 4px;
  gap: 4px;
}

.tab {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.2s;
  position: relative;
  border-radius: var(--radius-sm);
  margin: 4px 0;
}

.tab:hover {
  background-color: var(--bg-hover);
  color: var(--text-primary);
}

.tab.active {
  color: var(--primary);
  background-color: var(--bg-active);
}

.tab.active::after {
  display: none; /* Removed the gradient underline for a button-like tab */
}

.panel-content {
  padding: 20px;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.preset-section {
  margin: -20px;
  flex: 1;
  min-height: 0;
}

/* Section Styling */
.style-group {
  background: var(--bg-app);
  padding: 16px;
  border-radius: var(--radius-md);
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-sm);
}

.indent {
  padding-left: 8px;
  margin-top: 12px;
}

.mini-num {
  width: 50px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  font-family: var(--font-body);
  font-size: 12px;
  text-align: center;
  color: var(--text-primary);
  border-radius: var(--radius-sm);
  padding: 4px;
}

.mini-num:focus {
  outline: 2px solid var(--primary);
  border-color: transparent;
}

.mt-2 { margin-top: 12px; }

.panel-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 16px;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
}

.panel-title::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 14px;
  background-color: var(--primary);
  margin-right: 8px;
  border-radius: 2px;
}

.panel-title.sub {
  margin-top: 20px;
  color: var(--text-muted);
  border-left: none;
  padding-left: 0;
}
.panel-title.sub::before { display: none; }

.section { margin-bottom: 24px; }
.control { margin-bottom: 16px; }

.label-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

/* Font Dropdown */
.font-dropdown-container {
  height: 240px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.font-list-custom {
  height: 100%;
  overflow-y: auto;
}

.font-option {
  padding: 12px 16px;
  font-size: 14px;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s;
  border-bottom: 1px solid var(--border-color);
}

.font-option:hover {
  background-color: var(--bg-hover);
  color: var(--primary);
}

.font-option.active {
  background-color: var(--bg-active);
  color: var(--primary);
  font-weight: 600;
}

/* Inputs */
.full-color-input {
  width: 100%;
  height: 40px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  padding: 4px;
}

input[type="range"] {
  width: 100%;
  accent-color: var(--primary);
  height: 6px;
  border-radius: 3px;
  -webkit-appearance: none;
  background: var(--border-active);
}

/* Grid Controls */
.grid-controls {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}

.small-control input {
  width: 100%;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 6px;
  color: var(--text-primary);
  font-size: 12px;
}

.small-control label {
  display: block;
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  font-weight: 600;
}

/* Colors List */
.color-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.color-item {
  background-color: var(--bg-panel);
  padding: 12px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  gap: 12px;
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-sm);
}

.color-swatch {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.apply-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: var(--radius-md);
  background: var(--primary);
  color: white;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: var(--shadow-sm);
}

.apply-btn:hover {
  background-color: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.mini-btn {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  color: var(--primary);
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
}

.mini-btn:hover {
  background: var(--bg-hover);
  border-color: var(--primary);
}

/* Effects Grid */
.effects-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.effect-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}

.effect-card:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
  background-color: var(--bg-hover);
}

.effect-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-primary);
  margin-top: 10px;
}

.empty-note {
  font-size: 13px;
  color: var(--text-muted);
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: var(--bg-generated); /* Fallback or new var */
  border-radius: var(--radius-md);
  border: 1px dashed var(--border-color);
}

.remove-btn {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  transition: color 0.2s;
}

.remove-btn:hover {
  color: #ef4444; /* Red-500 */
}

.divider-text {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 8px 16px;
  background: var(--bg-app);
  border-top: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
}

.font-actions {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 4px;
}

.tabs-small {
  display: flex;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 2px;
  gap: 2px;
}

.tab-small {
  flex: 1;
  border: none;
  background: transparent;
  padding: 4px;
  border-radius: 2px;
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-small.active {
  background: var(--bg-active);
  color: var(--primary);
}

.tab-small:hover {
  color: var(--text-primary);
}

.mb-4 { margin-bottom: 16px; }
.my-2 { margin-top: 8px; margin-bottom: 8px; }

.gradient-editor {
  padding: 8px 0;
}

.gradient-ramp {
  height: 24px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
  position: relative;
  cursor: crosshair;
}

.gradient-thumb {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 12px;
  transform: translateX(-50%);
  cursor: grab;
}

.gradient-thumb input[type="color"] {
  width: 12px;
  height: 24px;
  padding: 0;
  border: 2px solid white;
  border-radius: 2px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  cursor: pointer;
}

.remove-stop {
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  background: none;
  border: none;
  font-size: 10px;
  color: #ef4444;
  cursor: pointer;
  display: none;
}

.gradient-thumb:hover .remove-stop {
  display: block;
}

.btn-outline {
  display: block;
  text-align: center;
  padding: 8px;
  border: 1px dashed var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 13px;
  transition: all 0.2s;
}

.btn-outline:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--bg-hover);
}

.mini-select {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 4px;
  border-radius: var(--radius-sm);
  width: 100%;
}

.logo {
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.5px;
  background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.divider-line {
  height: 1px;
  background-color: var(--border-color);
  width: 100%;
}

/* Layer Management */
.layer-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 8px;
  margin-bottom: 8px;
}

.layer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
}

.remove-layer {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  padding: 0 4px;
}

.remove-layer:hover {
  color: #ef4444;
}

.header-actions {
  display: flex;
  gap: 4px;
}

.mini-btn-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-hover);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  cursor: pointer;
  color: var(--text-primary);
  font-size: 12px;
}

.mini-btn-icon:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.empty-state-small {
  font-size: 12px;
  color: var(--text-muted);
  text-align: center;
  padding: 8px;
  font-style: italic;
}
  /* Existing styles... */

  /* Warp Controls */
  .warp-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }
  
  .warp-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background-color: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-secondary);
    font-size: 10px;
    gap: 4px;
  }
  
  .warp-btn:hover {
    background-color: var(--bg-hover);
    color: var(--text-primary);
  }
  
  .warp-btn.active {
    background-color: var(--bg-active);
    border-color: var(--primary);
    color: var(--primary);
  }
  
  /* Warp Controls */
  /* ... existin ... */

  /* 3D Controls */
  .grid-3-col {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .material-chip {
    padding: 6px;
    font-size: 11px;
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    color: var(--text-secondary);
  }
  
  .material-chip:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }
  
  .material-chip.active {
    background: var(--bg-active);
    border-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
  }
</style>
